# Architecture — Technical Stack, Structure, and Environment

---

## Tech Stack (Exact Versions)

| Layer | Technology | Version | Purpose |
|-------|-----------|---------|---------|
| Framework | Next.js | 15.x (latest) | App Router, Server Components, API Routes |
| Language | TypeScript | 5.x | Strict mode, no `any` |
| Database | PostgreSQL | 16.x | Primary data store |
| ORM | Prisma | 6.x (latest) | Type-safe database access |
| Styling | Tailwind CSS | 4.x (latest) | Utility-first CSS |
| Components | shadcn/ui | latest | Radix-based accessible components |
| Icons | Lucide React | latest | Consistent icon set |
| Auth | NextAuth.js | 4.x | Magic link authentication |
| Validation | Zod | 3.x | Schema validation for forms and APIs |
| Data Fetching | @tanstack/react-query | 5.x | Client-side data fetching with caching |
| PDF Generation | jspdf + jspdf-autotable | latest | Report PDF output |
| Excel Generation | exceljs | latest | Report XLSX output |
| HTML Sanitization | sanitize-html | latest | Safe rendering of SAP HTML content |
| DOCX Parsing | mammoth | latest | BPD DOCX → HTML extraction |
| PDF Parsing | pdf-parse | latest | Setup guide page count extraction |
| ZIP Processing | adm-zip | latest | SAP ZIP file ingestion |
| XLSX Parsing | xlsx (SheetJS) | latest | BPD/Config XLSX reading |
| Testing | Vitest | latest | Unit and integration tests |
| Testing Utils | @testing-library/react | latest | Component testing |
| Date Handling | date-fns | latest | Date formatting (no moment.js) |
| MFA | otpauth | latest | TOTP MFA generation and verification |
| QR Code | qrcode | latest | QR code generation for MFA enrollment |
| WebAuthn Server | @simplewebauthn/server | latest | WebAuthn server-side operations (optional MFA upgrade) |
| WebAuthn Browser | @simplewebauthn/browser | latest | WebAuthn browser-side operations |
| Image Conversion | sharp | latest | SVG → PNG/PDF conversion for flow diagram export |
| Crypto | crypto (built-in) | — | Session token generation, TOTP secret encryption |

### Explicitly NOT Used

| Technology | Reason |
|-----------|--------|
| Redux / Zustand | Unnecessary — React Query + Server Components sufficient |
| Styled Components / CSS Modules | Tailwind only |
| Moment.js | Bloated — use date-fns |
| Axios | Unnecessary — native fetch sufficient |
| Any AI/LLM SDK | Portal logic is deterministic, no AI at runtime |
| Socket.io / WebSockets | No real-time requirements in v1 |
| Docker | Not needed for development; deploy via Vercel or similar |

---

## Project Structure

```
/workspaces/cockpit/fit-portal/
│
├── .env.local                              # Environment variables (not committed)
├── .eslintrc.json                          # ESLint configuration
├── .gitignore
├── HANDOFF.md                              # Agent handoff state document
├── README.md                               # Project overview (auto-generated, minimal)
├── next.config.ts                          # Next.js configuration
├── package.json
├── pnpm-lock.yaml
├── postcss.config.js
├── tailwind.config.ts                      # Extended with design system tokens
├── tsconfig.json                           # TypeScript strict mode
├── vitest.config.ts                        # Test configuration
│
├── prisma/
│   ├── schema.prisma                       # EXACTLY as in DATA-MODEL.md
│   ├── migrations/                         # Auto-generated by Prisma
│   └── seed.ts                             # Seeds Intelligence Layer defaults
│
├── scripts/
│   ├── ingest-sap-zip.ts                   # Main ZIP → DB ingestion script
│   ├── verify-data.ts                      # Data completeness verification (13 checks)
│   └── verify-db.ts                        # Database connection verification
│
├── public/
│   ├── logo-bound.svg                      # Bound ≈ logo mark
│   ├── logo-light.svg                      # Bound wordmark (light bg)
│   └── favicon.ico                         # Static fallback favicon
│
├── specs/                                  # Symlink → /workspaces/cockpit/specs/fit-portal/
│
├── src/
│   ├── app/
│   │   ├── layout.tsx                      # Root layout: fonts, metadata, providers
│   │   ├── page.tsx                        # Redirect to /assessments
│   │   ├── globals.css                     # Tailwind directives + custom CSS
│   │   │
│   │   ├── (auth)/                         # Auth route group (no layout chrome)
│   │   │   ├── login/
│   │   │   │   └── page.tsx                # Login page with magic link
│   │   │   ├── mfa/
│   │   │   │   ├── setup/
│   │   │   │   │   └── page.tsx            # MFA enrollment: QR code + TOTP verification
│   │   │   │   └── verify/
│   │   │   │       └── page.tsx            # MFA verification on login (TOTP entry)
│   │   │   └── layout.tsx                  # Minimal layout (centered, no nav)
│   │   │
│   │   ├── (portal)/                       # Main portal route group
│   │   │   ├── layout.tsx                  # Portal layout with top nav
│   │   │   ├── assessments/
│   │   │   │   ├── page.tsx                # Screen 0: Assessment list
│   │   │   │   └── new/
│   │   │   │       └── page.tsx            # Screen 1: Company profile / new assessment
│   │   │   │
│   │   │   ├── dashboard/
│   │   │   │   └── page.tsx                # Per-company progress dashboard
│   │   │   │
│   │   │   └── assessment/
│   │   │       └── [id]/
│   │   │           ├── layout.tsx          # Assessment layout with sidebar/tabs
│   │   │           ├── scope/
│   │   │           │   └── page.tsx        # Screen 2: Scope selection
│   │   │           ├── review/
│   │   │           │   ├── page.tsx        # Redirect to first selected scope item
│   │   │           │   └── [scopeItemId]/
│   │   │           │       └── page.tsx    # Screen 3: Process deep dive
│   │   │           ├── config/
│   │   │           │   └── page.tsx        # Screen 4: Configuration matrix
│   │   │           ├── gaps/
│   │   │           │   └── page.tsx        # Screen 5: Gap resolution summary
│   │   │           ├── flows/
│   │   │           │   └── page.tsx        # Process Flow Atlas viewer
│   │   │           ├── remaining/
│   │   │           │   └── page.tsx        # Remaining Items Register view
│   │   │           └── report/
│   │   │               └── page.tsx        # Screen 6: Final report
│   │   │
│   │   ├── (admin)/                        # Internal admin route group
│   │   │   ├── layout.tsx                  # Admin layout with admin nav
│   │   │   ├── intelligence/
│   │   │   │   ├── industries/
│   │   │   │   │   └── page.tsx            # Industry profile management
│   │   │   │   ├── effort/
│   │   │   │   │   └── page.tsx            # Effort baseline management
│   │   │   │   ├── extensibility/
│   │   │   │   │   └── page.tsx            # Extensibility pattern management
│   │   │   │   └── adaptations/
│   │   │   │       └── page.tsx            # Adaptation pattern management
│   │   │   ├── ingest/
│   │   │   │   └── page.tsx                # SAP ZIP ingestion UI
│   │   │   └── dashboard/
│   │   │       └── page.tsx                # Assessment overview dashboard
│   │   │
│   │   └── api/
│   │       ├── auth/
│   │       │   ├── [...nextauth]/
│   │       │   │   └── route.ts            # NextAuth handler
│   │       │   └── mfa/
│   │       │       ├── setup/
│   │       │       │   └── route.ts        # POST: initiate TOTP setup, GET: QR code data
│   │       │       ├── verify/
│   │       │       │   └── route.ts        # POST: verify TOTP code
│   │       │       └── status/
│   │       │           └── route.ts        # GET: MFA enrollment status
│   │       ├── assessments/
│   │       │   ├── route.ts                # GET (list), POST (create)
│   │       │   └── [id]/
│   │       │       ├── route.ts            # GET, PATCH, DELETE
│   │       │       ├── stakeholders/
│   │       │       │   └── route.ts        # GET, POST
│   │       │       ├── scope/
│   │       │       │   ├── route.ts        # GET (all selections)
│   │       │       │   ├── [scopeItemId]/
│   │       │       │   │   └── route.ts    # PUT (upsert selection)
│   │       │       │   └── bulk/
│   │       │       │       └── route.ts    # POST (bulk update)
│   │       │       ├── steps/
│   │       │       │   ├── route.ts        # GET (paginated)
│   │       │       │   ├── [stepId]/
│   │       │       │   │   └── route.ts    # PUT (upsert response)
│   │       │       │   └── bulk/
│   │       │       │       └── route.ts    # POST (bulk mark FIT)
│   │       │       ├── gaps/
│   │       │       │   ├── route.ts        # GET (all gaps)
│   │       │       │   └── [gapId]/
│   │       │       │       └── route.ts    # PUT (upsert resolution)
│   │       │       ├── decision-log/
│   │       │       │   └── route.ts        # GET (paginated, filterable)
│   │       │       ├── flows/
│   │       │       │   ├── route.ts        # GET: list flow diagrams, POST: generate
│   │       │       │   └── [flowId]/
│   │       │       │       ├── route.ts    # GET: single diagram (SVG)
│   │       │       │       └── pdf/
│   │       │       │           └── route.ts # GET: single diagram (PDF)
│   │       │       ├── remaining/
│   │       │       │   └── route.ts        # GET: list remaining items, POST: add manual item
│   │       │       └── report/
│   │       │           ├── executive-summary/
│   │       │           │   └── route.ts    # GET (PDF)
│   │       │           ├── scope-catalog/
│   │       │           │   └── route.ts    # GET (XLSX)
│   │       │           ├── step-detail/
│   │       │           │   └── route.ts    # GET (XLSX)
│   │       │           ├── gap-register/
│   │       │           │   └── route.ts    # GET (XLSX)
│   │       │           ├── config-workbook/
│   │       │           │   └── route.ts    # GET (XLSX)
│   │       │           ├── audit-trail/
│   │       │           │   └── route.ts    # GET (XLSX)
│   │       │           ├── flow-atlas/
│   │       │           │   └── route.ts    # GET: complete Process Flow Atlas (PDF)
│   │       │           ├── remaining-register/
│   │       │           │   └── route.ts    # GET: Remaining Items Register (XLSX)
│   │       │           └── sign-off/
│   │       │               └── route.ts    # POST
│   │       ├── dashboard/
│   │       │   └── route.ts                # GET: per-company progress dashboard data
│   │       ├── catalog/
│   │       │   ├── scope-items/
│   │       │   │   ├── route.ts            # GET (list, filterable)
│   │       │   │   └── [id]/
│   │       │   │       ├── route.ts        # GET (one scope item)
│   │       │   │       ├── steps/
│   │       │   │       │   └── route.ts    # GET (paginated steps)
│   │       │   │       └── configs/
│   │       │   │           └── route.ts    # GET (config activities)
│   │       │   ├── config-activities/
│   │       │   │   └── route.ts            # GET (list, filterable)
│   │       │   └── setup-guide/
│   │       │       └── [scopeItemId]/
│   │       │           └── route.ts        # GET (serve PDF binary)
│   │       └── admin/
│   │           ├── industry-profiles/
│   │           │   └── route.ts            # CRUD
│   │           ├── effort-baselines/
│   │           │   └── route.ts            # CRUD
│   │           ├── extensibility-patterns/
│   │           │   └── route.ts            # CRUD
│   │           ├── adaptation-patterns/
│   │           │   └── route.ts            # CRUD
│   │           ├── ingest/
│   │           │   └── route.ts            # POST (trigger ingestion)
│   │           └── verify/
│   │               └── route.ts            # GET (run verification)
│   │
│   ├── components/
│   │   ├── ui/                             # shadcn/ui base components (generated)
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   ├── input.tsx
│   │   │   ├── select.tsx
│   │   │   ├── radio-group.tsx
│   │   │   ├── checkbox.tsx
│   │   │   ├── dialog.tsx
│   │   │   ├── progress.tsx
│   │   │   ├── badge.tsx
│   │   │   ├── textarea.tsx
│   │   │   ├── tabs.tsx
│   │   │   ├── separator.tsx
│   │   │   ├── skeleton.tsx
│   │   │   ├── tooltip.tsx
│   │   │   ├── dropdown-menu.tsx
│   │   │   ├── scroll-area.tsx
│   │   │   └── accordion.tsx
│   │   │
│   │   ├── layout/                         # Layout components
│   │   │   ├── PortalNav.tsx               # Top navigation bar
│   │   │   ├── AssessmentSidebar.tsx       # Assessment step sidebar
│   │   │   ├── ReviewSidebar.tsx           # Scope item list sidebar (Screen 3)
│   │   │   └── PageHeader.tsx              # Page header with breadcrumbs
│   │   │
│   │   ├── assessment/                     # Screen 1 components
│   │   │   ├── CompanyProfileForm.tsx      # Company profile input form
│   │   │   ├── StakeholderManager.tsx      # Add/manage stakeholders
│   │   │   └── IndustrySelector.tsx        # Industry selection grid
│   │   │
│   │   ├── scope/                          # Screen 2 components
│   │   │   ├── ScopeAreaGroup.tsx          # Functional area grouping
│   │   │   ├── ScopeItemCard.tsx           # Individual scope item card
│   │   │   ├── ScopeProgress.tsx           # Progress indicator
│   │   │   └── CurrentStateSelector.tsx    # Current state radio group
│   │   │
│   │   ├── review/                         # Screen 3 components
│   │   │   ├── ProcessFlowOverview.tsx     # Flow cards for a scope item
│   │   │   ├── StepReviewCard.tsx          # Individual step review card
│   │   │   ├── SapContentRenderer.tsx      # Renders SAP HTML content safely
│   │   │   ├── ClientResponseForm.tsx      # Fit/Gap/Configure/NA selection
│   │   │   ├── RelatedConfigList.tsx       # Related config activities display
│   │   │   ├── StepNavigation.tsx          # Prev/Next + step picker
│   │   │   ├── StepTypeFilter.tsx          # Toggle to hide LOGON steps
│   │   │   └── BatchFitDialog.tsx          # "Mark remaining as FIT" dialog
│   │   │
│   │   ├── gaps/                           # Screen 5 components
│   │   │   ├── GapSummaryDashboard.tsx     # Gap statistics overview
│   │   │   ├── GapResolutionCard.tsx       # Individual gap with resolution options
│   │   │   ├── ResolutionOptionCard.tsx    # Single resolution option display
│   │   │   ├── AdaptComparison.tsx         # Side-by-side EXTEND vs ADAPT
│   │   │   ├── WhatIfCalculator.tsx        # Toggle gaps to see total change
│   │   │   └── RationaleInput.tsx          # Required rationale text input
│   │   │
│   │   ├── config/                         # Screen 4 components
│   │   │   ├── ConfigMatrix.tsx            # Main config activity table
│   │   │   ├── ConfigCategoryBadge.tsx     # Mandatory/Recommended/Optional
│   │   │   ├── ConfigAreaGroup.tsx         # Grouped by functional area
│   │   │   └── SetupGuidePdfViewer.tsx     # Inline PDF viewer
│   │   │
│   │   ├── report/                         # Screen 6 components
│   │   │   ├── ReportSectionList.tsx       # List of all report sections
│   │   │   ├── ExecutiveSummary.tsx        # Inline executive summary
│   │   │   ├── ReportDownloadButton.tsx    # Download trigger
│   │   │   ├── SignOffForm.tsx             # Digital sign-off
│   │   │   └── FitAnalysisChart.tsx        # Visual fit/gap breakdown
│   │   │
│   │   ├── mfa/                            # MFA components
│   │   │   ├── TotpSetupForm.tsx           # QR code display + code verification
│   │   │   ├── TotpVerifyForm.tsx          # 6-digit code input
│   │   │   └── MfaStatusBadge.tsx          # MFA enabled/disabled indicator
│   │   │
│   │   ├── dashboard/                      # Dashboard components
│   │   │   ├── CompanyProgress.tsx         # Per-company progress overview
│   │   │   ├── TeamActivity.tsx            # Team member activity feed
│   │   │   ├── AreaProgressGrid.tsx        # Progress by functional area
│   │   │   └── StakeholderProgress.tsx     # Per-person progress breakdown
│   │   │
│   │   ├── flow-diagram/                   # Flow diagram components
│   │   │   ├── FlowDiagramViewer.tsx       # Interactive SVG viewer with zoom/pan
│   │   │   ├── FlowStepNode.tsx            # Individual step node in diagram
│   │   │   └── FlowLegend.tsx              # Color legend for fit statuses
│   │   │
│   │   ├── remaining/                      # Remaining items components
│   │   │   ├── RemainingItemsList.tsx      # Sortable/filterable remaining items table
│   │   │   ├── RemainingItemCard.tsx       # Individual remaining item display
│   │   │   └── RemainingItemForm.tsx       # Manual remaining item entry
│   │   │
│   │   └── shared/                         # Shared components
│   │       ├── StatusBadge.tsx             # FIT/CONFIGURE/EXTEND/BUILD/ADAPT badge
│   │       ├── ProgressBar.tsx             # Styled progress bar
│   │       ├── EmptyState.tsx              # Generic empty state with icon + message
│   │       ├── ErrorBoundary.tsx           # Error boundary with retry
│   │       ├── LoadingSkeleton.tsx         # Generic skeleton loader
│   │       └── BoundLogo.tsx              # ≈ logo component
│   │
│   ├── lib/
│   │   ├── db/
│   │   │   ├── prisma.ts                   # Prisma client singleton
│   │   │   ├── scope-items.ts              # ScopeItem queries
│   │   │   ├── process-steps.ts            # ProcessStep queries
│   │   │   ├── config-activities.ts        # ConfigActivity queries
│   │   │   ├── assessments.ts              # Assessment CRUD
│   │   │   ├── step-responses.ts           # StepResponse CRUD
│   │   │   ├── gap-resolutions.ts          # GapResolution CRUD
│   │   │   └── decision-log.ts             # DecisionLogEntry (append-only)
│   │   │
│   │   ├── sap/
│   │   │   ├── step-type-normalizer.ts     # Action title → step type mapping
│   │   │   ├── html-sanitizer.ts           # SAP HTML sanitization config
│   │   │   └── scope-item-utils.ts         # Name cleaning, area mapping
│   │   │
│   │   ├── decision/
│   │   │   ├── resolution-types.ts         # Resolution type definitions
│   │   │   ├── effort-calculator.ts        # Effort estimation logic
│   │   │   └── confidence-calculator.ts    # Confidence score calculation
│   │   │
│   │   ├── report/
│   │   │   ├── pdf-generator.ts            # PDF report generation
│   │   │   ├── xlsx-generator.ts           # XLSX report generation
│   │   │   └── report-data-assembler.ts    # Assembles data for reports
│   │   │
│   │   ├── audit/
│   │   │   └── decision-logger.ts          # Utility to log decisions
│   │   │
│   │   ├── auth/
│   │   │   ├── auth-options.ts             # NextAuth configuration
│   │   │   ├── session.ts                  # Session utilities
│   │   │   ├── mfa.ts                      # TOTP setup/verification, secret encryption
│   │   │   ├── webauthn.ts                 # WebAuthn registration/verification
│   │   │   └── permissions.ts              # Area-locked editing middleware, role checks
│   │   │
│   │   ├── flow-diagram/
│   │   │   ├── generator.ts               # SVG flow diagram generation from process steps
│   │   │   ├── renderer.ts                # Step-to-SVG rendering with color coding
│   │   │   └── pdf-converter.ts           # SVG → PDF conversion
│   │   │
│   │   └── remaining/
│   │       └── auto-generator.ts           # Auto-detect remaining items from assessment data
│   │
│   ├── types/
│   │   ├── sap.ts                          # SAP data types (ScopeItem, ProcessStep, etc.)
│   │   ├── assessment.ts                   # Assessment types
│   │   ├── api.ts                          # API request/response types
│   │   ├── decision.ts                     # Decision framework types
│   │   └── report.ts                       # Report generation types
│   │
│   └── constants/
│       ├── ui-text.ts                      # ALL user-facing strings (no hardcoded text in JSX)
│       ├── resolution-types.ts             # Resolution type labels, colors, descriptions
│       ├── step-types.ts                   # Step type labels and icons
│       ├── functional-areas.ts             # Functional area labels and sort order
│       └── config.ts                       # App configuration constants
│
├── tests/
│   ├── unit/
│   │   ├── step-type-normalizer.test.ts
│   │   ├── effort-calculator.test.ts
│   │   ├── confidence-calculator.test.ts
│   │   ├── html-sanitizer.test.ts
│   │   ├── scope-item-utils.test.ts
│   │   ├── mfa.test.ts
│   │   ├── permissions.test.ts
│   │   └── flow-diagram-generator.test.ts
│   ├── integration/
│   │   ├── api/
│   │   │   ├── assessments.test.ts
│   │   │   ├── scope-selection.test.ts
│   │   │   ├── step-responses.test.ts
│   │   │   ├── gap-resolutions.test.ts
│   │   │   ├── catalog.test.ts
│   │   │   ├── mfa.test.ts
│   │   │   ├── flow-diagrams.test.ts
│   │   │   └── remaining-items.test.ts
│   │   └── db/
│   │       ├── scope-items.test.ts
│   │       └── decision-log.test.ts
│   └── verification/
│       └── data-completeness.test.ts       # Mirrors verify-data.ts as a test suite
│
└── .github/                                # CI/CD (future)
    └── workflows/
        └── ci.yml
```

---

## Environment Variables

```bash
# .env.local (fit-portal)

# Database — same PostgreSQL instance, different database
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/fit_portal"

# Auth
NEXTAUTH_SECRET="fit-portal-secret-key-for-local-dev-only-min-32"
NEXTAUTH_URL="http://localhost:3003"

# SAP ZIP location (for ingestion script)
SAP_ZIP_PATH="/workspaces/cockpit/SAP_Best_Practices_for_SAP_S4HANA_Cloud_Public_Edition_2508_MY_SAPCUSTOMER.zip"

# App
NODE_ENV="development"

# MFA
TOTP_ENCRYPTION_KEY="32-byte-hex-key-for-encrypting-totp-secrets"
TOTP_ISSUER="Bound Fit Portal"

# Session
SESSION_MAX_AGE_HOURS=24
SESSION_CONCURRENT_LIMIT=1

# WebAuthn (optional)
WEBAUTHN_RP_ID="localhost"
WEBAUTHN_RP_NAME="Bound Fit Portal"
WEBAUTHN_ORIGIN="http://localhost:3003"
```

**Port**: 3003 (to avoid conflict with main Bound portal on 3002)
**Database**: `fit_portal` (separate from main `cockpit` database)

---

## npm Scripts

```json
{
  "scripts": {
    "dev": "next dev -p 3003",
    "build": "next build",
    "start": "next start -p 3003",
    "lint:strict": "next lint --max-warnings 0",
    "typecheck:strict": "tsc --noEmit --strict",
    "test": "vitest",
    "test:run": "vitest run",
    "verify:data": "tsx scripts/verify-data.ts",
    "verify:mfa": "tsx scripts/verify-mfa.ts",
    "ingest": "tsx scripts/ingest-sap-zip.ts",
    "generate:flows": "tsx scripts/generate-flow-diagrams.ts",
    "db:push": "prisma db push",
    "db:generate": "prisma generate",
    "db:seed": "tsx prisma/seed.ts",
    "db:studio": "prisma studio --port 5556"
  }
}
```

---

## Key Architectural Decisions

### 1. Server Components by Default
All pages are Server Components. Only interactive components (forms, step review card, gap resolution selector) use `"use client"`.

### 2. No Global State Management
- SAP catalog data: Server Components query DB directly
- Assessment data: React Query with server-side prefetching
- Form state: React Hook Form (local to each form)
- No Redux, no Zustand, no Context for shared state

### 3. Separate Database
The fit-portal uses its own PostgreSQL database (`fit_portal`), completely separate from the main Bound portal's `cockpit` database. This ensures:
- Independent schema evolution
- No risk of cross-contamination
- Can be backed up/restored independently
- Can be deployed to a different server if needed

### 4. Binary Storage in PostgreSQL
Setup PDFs and general files are stored as `Bytes` (bytea) in PostgreSQL, not in external blob storage. For the expected data volume (~287MB total), this is simpler and sufficient. If the dataset grows significantly (multiple SAP releases), migrate to S3/R2.

### 5. Cursor-Based Pagination
All list endpoints use cursor-based pagination (not offset-based) for consistent performance:
```typescript
{
  data: T[],
  nextCursor: string | null,
  hasMore: boolean
}
```

### 6. Immutable Decision Log
The DecisionLogEntry table has NO update or delete operations. The Prisma client wrapper for this table only exposes `create` and `findMany`. This is enforced by the query layer, not just convention.

### 7. TOTP-Based MFA
External users (process_owner, it_lead, executive) must complete TOTP MFA setup on first login and verify TOTP on every subsequent login. TOTP secrets are encrypted at rest using AES-256-GCM with the `TOTP_ENCRYPTION_KEY`. WebAuthn is available as an optional upgrade but does not replace the initial TOTP requirement.

### 8. Area-Locked Permissions
The permission system is enforced at the API middleware layer via `src/lib/auth/permissions.ts`. Each API route handler wraps its logic with permission checks that verify: (a) the user has the correct role, (b) for process owners, the target entity's functional area is in their `assignedAreas`, (c) consultants performing cross-area edits have provided a reason (logged as PERMISSION_OVERRIDE). This is NOT a complex RBAC system — it's a simple middleware function.

### 9. Sequential Process Flow Diagrams
Flow diagrams are generated server-side as SVG by reading ProcessStep records grouped by `processFlowGroup`, enriched with StepResponse fit statuses. Each step is rendered as a colored node (green=FIT, blue=CONFIGURE, amber=GAP, gray=pending/NA) connected by arrows in sequence order. These are NOT BPMN diagrams — the SAP BPD data is inherently linear (no gateways, no parallel branches). The SVG is stored in the database and can be exported as PDF via the `sharp` library.

### 10. Remaining Items Auto-Generation
When an assessment reaches "completed" status, the system auto-generates a RemainingItem record for: each unreviewed step, each MAYBE scope item, each excluded Recommended config, each OUT_OF_SCOPE gap, and each scope item flagged with integration or data migration concerns. These can also be manually added. The Remaining Items Register is exported as XLSX.
